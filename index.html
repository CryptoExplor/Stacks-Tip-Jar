<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Stacks Tip Jar - Farcaster Miniapp</title>
  
  <!-- SEO Meta Tags -->
  <meta name="description" content="Send STX tips on Bitcoin L2 - Built with Clarity 4. A Farcaster miniapp for the Stacks ecosystem." />
  <meta name="keywords" content="stacks, bitcoin, tip jar, cryptocurrency, STX, farcaster, miniapp, clarity4, web3" />
  
  <!-- Open Graph / Farcaster Frame -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://stacks-chi.vercel.app" />
  <meta property="og:title" content="Stacks Tip Jar ‚ö° - Farcaster Miniapp" />
  <meta property="og:description" content="Send STX tips on Bitcoin L2 with Clarity 4 smart contracts" />
  <meta property="og:image" content="https://stacks-chi.vercel.app/og-image.png" />
  
  <!-- Farcaster Frame Tags -->
  <meta property="fc:frame" content="vNext" />
  <meta property="fc:frame:image" content="https://stacks-chi.vercel.app/og-image.png" />
  <meta property="fc:frame:image:aspect_ratio" content="1:1" />
  <meta property="fc:frame:button:1" content="Send Tip üí∏" />
  <meta property="fc:frame:button:1:action" content="link" />
  <meta property="fc:frame:button:1:target" content="https://stacks-chi.vercel.app" />
  <meta property="fc:frame:button:2" content="View Stats üìä" />
  <meta property="fc:frame:button:2:action" content="post" />
  
  <!-- Farcaster Miniapp Specific -->
  <meta name="fc:frame:app_version" content="2.0.0" />
  <meta name="fc:frame:manifest" content="https://stacks-chi.vercel.app/.well-known/farcaster.json" />
  
  <!-- PWA Support -->
  <meta name="theme-color" content="#667eea" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="/favicon.svg" />
  <link rel="apple-touch-icon" href="/icon.png" />
  
  <!-- Styles -->
  <link rel="stylesheet" href="/styles.css" />
  
  <!-- 
    CRITICAL: Import Farcaster SDK FIRST before any other scripts
    This ensures ready() is called as early as possible
  -->
  <script type="module">
    (async () => {
      console.log('üéØ [INLINE] Initializing Farcaster SDK...');
      
      try {
        // Import SDK
        const { sdk } = await import('@farcaster/miniapp-sdk');
        
        if (!sdk) {
          console.log('‚ÑπÔ∏è [INLINE] SDK not available');
          return;
        }
        
        console.log('‚úÖ [INLINE] SDK imported');
        
        // Call ready() IMMEDIATELY
        if (sdk.actions && typeof sdk.actions.ready === 'function') {
          console.log('üöÄ [INLINE] Calling sdk.actions.ready()...');
          
          // Try async call first
          try {
            await sdk.actions.ready();
            console.log('‚úÖ [INLINE] ready() called (async)');
          } catch (err) {
            // Fallback to sync call
            console.log('‚ö†Ô∏è [INLINE] Async ready() failed, trying sync...');
            try {
              sdk.actions.ready();
              console.log('‚úÖ [INLINE] ready() called (sync)');
            } catch (err2) {
              console.error('‚ùå [INLINE] Both ready() calls failed:', err2);
            }
          }
          
          // Store SDK globally
          window.__FARCASTER_SDK_INLINE__ = sdk;
        } else {
          console.warn('‚ö†Ô∏è [INLINE] sdk.actions.ready not found');
          console.log('Available:', Object.keys(sdk.actions || {}));
        }
      } catch (error) {
        console.log('‚ÑπÔ∏è [INLINE] Not in Farcaster:', error.message);
      }
    })();
  </script>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>‚ö° Stacks Tip Jar</h1>
      <p class="subtitle">Send STX tips on Bitcoin L2 ‚Ä¢ Built with Clarity 4</p>
      <div class="builder-badge">
        <span class="badge-icon">üèÜ</span>
        <span class="badge-text">Stacks Builder Challenge</span>
      </div>
    </header>

    <!-- Wallet Info -->
    <div class="wallet-info" id="walletInfo">
      <div class="wallet-info-header">
        <strong>Connected Wallet</strong>
        <span class="wallet-badge" id="walletBadge"></span>
      </div>
      <div class="wallet-address" id="walletAddress"></div>
      <div class="premium-status" id="premiumStatus" style="display: none;">
        <span class="premium-icon">üëë</span>
        <span class="premium-text">Premium Tipper</span>
      </div>
    </div>

    <!-- Stats Section -->
    <div class="stats" id="stats">
      <div class="stat-row">
        <span class="stat-label">Network:</span>
        <span class="stat-value" id="networkDisplay">Testnet</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Contract Balance:</span>
        <span class="stat-value" id="contractBalance">--</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Total Tips Received:</span>
        <span class="stat-value" id="totalTips">--</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Total Tippers:</span>
        <span class="stat-value" id="totalTippers">--</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Total Transactions:</span>
        <span class="stat-value" id="totalTransactions">--</span>
      </div>
      <div class="stat-row" id="userStatsRow" style="display: none;">
        <span class="stat-label">Your Total Tips:</span>
        <span class="stat-value" id="userTotalTips">--</span>
      </div>
    </div>

    <!-- Connect Wallet Section -->
    <div id="connectSection" class="show">
      <label class="section-label">Connect Your Wallet</label>
      <div class="wallet-buttons">
        <button class="wallet-btn" id="leatherBtn">
          <span class="wallet-icon">ü¶ä</span>
          <span>Leather</span>
        </button>
        <button class="wallet-btn" id="xverseBtn">
          <span class="wallet-icon">‚ö°</span>
          <span>Xverse</span>
        </button>
      </div>
      
      <button class="btn btn-appkit" id="appkitBtn">
        <span>Connect Wallet</span>
      </button>
      
      <div class="install-notice" id="installNotice">
        üí° Don't have a wallet? Install 
        <a href="https://leather.io" target="_blank" rel="noopener">Leather</a> or 
        <a href="https://xverse.app" target="_blank" rel="noopener">Xverse</a>
      </div>
    </div>

    <!-- Tip Section -->
    <div id="tipSection">
      <!-- Faucet Section (testnet only) -->
      <div id="faucetSection" class="faucet-section" style="display: none;">
        <div class="faucet-info">
          <span class="faucet-icon">üí∞</span>
          <span class="faucet-text">Need testnet STX? Claim from faucet!</span>
        </div>
        <button class="btn btn-faucet" id="faucetBtn">
          <span class="btn-icon">üí∞</span>
          <span>Claim 500 STX from Faucet</span>
        </button>
      </div>

      <div class="input-group">
        <label class="section-label">Quick Amounts</label>
        <div class="quick-amounts">
          <div class="quick-amount" data-amount="0.1">0.1 STX</div>
          <div class="quick-amount" data-amount="0.5">0.5 STX</div>
          <div class="quick-amount" data-amount="1">1 STX</div>
          <div class="quick-amount" data-amount="5">5 STX</div>
        </div>
      </div>

      <div class="input-group">
        <label for="amount" class="section-label">Custom Amount (STX)</label>
        <input 
          id="amount" 
          type="number" 
          step="0.000001" 
          min="0.000001"
          placeholder="Enter amount in STX"
          autocomplete="off"
        />
      </div>

      <button class="btn btn-primary" id="sendTipBtn">
        <span class="btn-icon">üí∏</span>
        <span>Send Tip</span>
      </button>

      <!-- Premium Achievement -->
      <div class="premium-info" id="premiumInfo" style="display: none;">
        <p>üéØ Tip 10+ STX total to become a Premium Tipper!</p>
        <div class="progress-bar">
          <div class="progress-fill" id="premiumProgress"></div>
        </div>
        <p class="progress-text" id="premiumProgressText">0 / 10 STX</p>
      </div>

      <!-- Owner-only Withdraw Button -->
      <button id="withdrawBtn" class="btn btn-secondary" style="display: none;">
        <span class="btn-icon">‚¨áÔ∏è</span>
        <span>Withdraw to Owner Wallet</span>
      </button>

      <button class="btn btn-secondary" id="refreshBtn">
        <span class="btn-icon">üîÑ</span>
        <span>Refresh Stats</span>
      </button>

      <button class="btn btn-secondary" id="disconnectBtn">
        <span class="btn-icon">üîå</span>
        <span>Disconnect Wallet</span>
      </button>
    </div>

    <!-- Status Messages -->
    <div class="status" id="status"></div>

    <!-- Footer -->
    <footer class="footer">
      <p>Built on <strong>Stacks</strong> ‚Ä¢ Secured by <strong>Bitcoin</strong></p>
      <p>Enhanced with <strong>Clarity 4</strong> ‚Ä¢ Farcaster Ready</p>
      <p class="footer-links">
        <a href="https://github.com/CryptoExplor/stacks-tip-jar" target="_blank" rel="noopener">GitHub</a>
        <span>‚Ä¢</span>
        <a href="https://docs.stacks.co/whats-new/clarity-4-is-now-live" target="_blank" rel="noopener">Clarity 4 Docs</a>
        <span>‚Ä¢</span>
        <a href="https://stacks.co" target="_blank" rel="noopener">Stacks.co</a>
      </p>
    </footer>
  </div>

  <!-- 
    Main application script 
    This loads AFTER the inline Farcaster SDK initialization
  -->
  <script type="module" src="/main.js"></script>
</body>
</html>
